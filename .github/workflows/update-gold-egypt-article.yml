name: Update Gold Egypt Article Table

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch gold EGP from Worker
        run: |
          curl -sS "https://hidden-snow-2c44.rab2323s.workers.dev/api/gold?currency=EGP" \
            -H "Accept: application/json" \
            -o /tmp/gold-egp.json

      - name: Inject table rows into article HTML
        run: |
          python3 - <<'PY'
          import json, re, pathlib

          # غيّر مسار المقال حسب مكانه الفعلي
          html_path = pathlib.Path("news/gold-price-egypt-today/index.html")

          data = json.loads(pathlib.Path("/tmp/gold-egp.json").read_text(encoding="utf-8"))
          price_oz_24k = float(data["price_oz_24k"])
          updated = data.get("updated_at","—")

          TROY_OZ_TO_G = 31.1034768
          g24 = price_oz_24k / TROY_OZ_TO_G

          def r2(x): return round(x, 2)
          karats = [24,22,21,18,14]
          rows = []
          for k in karats:
            price = r2(g24 * (k/24))
            rows.append(f"<tr><td><strong>{k}K</strong></td><td>{price} EGP</td></tr>")
          tbody_html = "<tbody id=\"egpTable\">\n" + "\n".join(rows) + "\n</tbody>"

          html = html_path.read_text(encoding="utf-8")

          html = re.sub(
            r"<!-- GOLD_EGP_TABLE_START -->.*?<!-- GOLD_EGP_TABLE_END -->",
            "<!-- GOLD_EGP_TABLE_START -->\n" + tbody_html + "\n<!-- GOLD_EGP_TABLE_END -->",
            html, flags=re.S
          )

          html = re.sub(
            r"<!-- GOLD_EGP_UPDATED_START -->.*?<!-- GOLD_EGP_UPDATED_END -->",
            f"<!-- GOLD_EGP_UPDATED_START -->آخر تحديث: {updated}<!-- GOLD_EGP_UPDATED_END -->",
            html, flags=re.S
          )

          html_path.write_text(html, encoding="utf-8")
          print("Injected gold table into:", html_path)
          PY

      - name: Commit & push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add news/gold-price-egypt-today/index.html
          git commit -m "Update Egypt gold table in article" || exit 0
          git push
