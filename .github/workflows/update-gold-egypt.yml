# .github/workflows/update-gold-egypt.yml
name: Update Gold Egypt (EGP) - prerender

on:
  schedule:
    - cron: "*/10 * * * *"  # كل 10 دقائق
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch gold EGP from Worker
        run: |
          curl -sS "https://hidden-snow-2c44.rab2323s.workers.dev/api/gold?currency=EGP" \
            -H "Accept: application/json" \
            -o /tmp/gold-egp.json

      - name: Inject initialGoldEGP into Egypt HTML
        run: |
          python3 - <<'PY'
          import json, re, pathlib

          # عدّل هذا المسار حسب مكان صفحة مصر في مشروعك
          html_path = pathlib.Path("tools/gold-price-egypt/index.html")

          raw = pathlib.Path("/tmp/gold-egp.json").read_text(encoding="utf-8")
          data = json.loads(raw)

          if not isinstance(data.get("price_oz_24k"), (int, float)):
              raise SystemExit("Invalid worker JSON: price_oz_24k missing or not a number")

          payload = {
              "currency": "EGP",
              "price_oz_24k": float(data["price_oz_24k"]),
              "updated_at": data.get("updated_at") or ""
          }

          new_block = (
              "<!-- INITIAL_GOLD_EGP_START -->\n"
              '<script type="application/json" id="initialGoldEGP">\n'
              + json.dumps(payload, ensure_ascii=False)
              + "\n</script>\n"
              "<!-- INITIAL_GOLD_EGP_END -->"
          )

          html = html_path.read_text(encoding="utf-8")
          pattern = r"<!-- INITIAL_GOLD_EGP_START -->.*?<!-- INITIAL_GOLD_EGP_END -->"

          if not re.search(pattern, html, flags=re.S):
              raise SystemExit("Markers not found. Add INITIAL_GOLD_EGP_START/END in HTML first.")

          html2 = re.sub(pattern, new_block, html, flags=re.S)
          html_path.write_text(html2, encoding="utf-8")
          print("Injected initial gold block into:", html_path)
          PY

      - name: Commit & push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add tools/gold-price-egypt/index.html
          git commit -m "Update Egypt gold initial price" || exit 0
          git push
